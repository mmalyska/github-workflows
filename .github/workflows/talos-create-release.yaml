---
name: Create new Talos assets release

on:
  workflow_call:
    inputs:
      repositoryName:
        description: "Target repository name"
        default: ${{ github.repository.full_name }}
        required: false
        type: string
      talosExtensionsImage:
        description: "Talos extensions"
        required: true
        type: string
      archList:
        description: "List of architectures to build"
        default: '[ "amd64", "arm64" ]'
        required: false
        type: string
      pushToRegistry:
        default: true
        type: boolean
        required: false
      createRelease:
        default: true
        type: boolean
        required: false

jobs:
  check-release:
    uses: mmalyska/github-workflows/.github/workflows/talos-check-new-image.yaml@main
    with:
      repositoryName: ${{ inputs.repositoryName }}
  build-release:
    strategy:
      matrix:
        arch: ${{ fromJSON(inputs.archList) }}
    needs: [ check-release ]
    if: needs.check-release.outputs.newTalosReleaseFound
    uses: mmalyska/github-workflows/.github/workflows/talos-build-image.yaml@main
    with:
      talosVersion: ${{ needs.check-release.outputs.talosReleaseTag }}
      talosExtensionsImage: ${{ inputs.talosExtensionsImage }}
      arch: ${{ matrix.arch }}
  create-release:
    if: ${{ inputs.createRelease }}
    needs: [ build-release, check-release ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download build asset images
        uses: actions/download-artifact@v3
        with:
          name: talos-images
          path: /tmp/talos-assets

      - name: Create a new release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-release.outputs.talosReleaseTag }}
          body: ${{ needs.check-release.outputs.talosReleaseBody }}
          files: |
            /tmp/talos-assets/*
  push-images:
    if: ${{ inputs.pushToRegistry }}
    needs: [ build-release, check-release ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Download build asset images
        uses: actions/download-artifact@v3
        with:
          name: talos-installer
          path: /tmp/talos-assets

      - name: Log in to the Container registry
        uses: docker/login-action@v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Load ad push image
        run: |
          ARRAY=$(echo "${{ inputs.archList }}" | jq -r '.[]')
          for ARCH in $ARRAY; do docker load --input /tmp/talos-assets/metal-$ARCH-installer.tar; done
          docker image ls
